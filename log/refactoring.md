## リファクタリング総括（2025-11-22）

### 完了した主な取り組み
- core・scenes・shader 各層の依存関係を棚卸しし、描画と MIDI の責務境界を把握。
- `BandManager` をクラス化し、パラメータ解決・描画・数値表示を個別メソッドへ段階分割。`NumberDisplayController` 抽出で数字描画ロジックを外部化。
- Scene インターフェースを再定義し、`TexManager`/`UIManager`/`main.ts` からの呼び出し契約を統一。
- `APCMiniMK2Manager` をメソッド単位で分割し、LED 出力・入力ハンドラ・ランダムフェーダー制御を整理。未使用のキーボードフォールバックを撤去。
- MIDI 汎用処理を `src/midi/utils.ts` と `RandomFaderController` へ移し、ランダム処理や LED 色整備を共通化。
- グリッド LED の強度計算を `getGridPadVelocity` へ抽出し、マジックナンバー削減と maxOptions=0 ケースへの対応を明確化。
- `UIManager` のテクスチャ参照を `undefined` ベースに揃え、型不整合警告を解消。
- 各ステップで `npm run build` を実行し、描画結果を維持したまま進捗をログに記録。

### 現状の評価と観測事項
- core ⇔ scenes ⇔ midi の依存は明確化できたが、`BandManager` 内の描画補助と MIDI 値マッピングが依然密結合。
- `APCMiniMK2Manager` のクラス外ヘルパー抽出は進んだものの、ファイル規模と状態保持はまだ大きく、モジュール分割余地あり。
- utils 配下には未参照モジュールが残存。現行挙動を壊さずに整理するための優先順位付けが必要。
- シェーダ周辺は未着手で、uniform の命名やマジックナンバー整理が宿題として残る。
- テスト/README 整備は手付かず。今回のリファクタをどこまで自動検証で担保するか検討が必要。
- ログが肥大化してきたため、完了フェーズの要約と未完了タスクの優先度を明示する体制に切り替える。

---

## 改訂計画（2025-11-22）

### フェーズ A: MIDI コアの分割（優先度: 高）
- `APCMiniMK2Manager` を「入力処理」「ランダム更新」「LED 出力」のサブモジュールに分割し、テスト可能な純粋ロジックをコントローラ層へ退避。
- LED 出力で使用しているカラーマップとノート番号テーブルを `constants.ts`（仮）へ移し、UI 変更時の影響を局所化。
- ランダム系の時間管理ロジックを `RandomFaderController` に集約し、グリッド用ランダム処理も同じ仕組みで扱う案を検証。
- このフェーズ完了後に `npm run build` と実デバイスでの MIDI 入出力チェックを実施し、ログに成果と課題を追記。

### フェーズ B: BandManager の描画責務整理（優先度: 中）
- `BandManager` から描画補助関数を `BandRenderer`（仮）へ抽出し、MIDI 値との変換層と描画層を分離。
- 数値表示の判定/配置ロジックを `NumberDisplayController` で完結させ、`BandManager` 側では最終結果のみ反映する構造へ移行。
- 描画に使用する設定値をシリアライズ可能なデータ構造にまとめ、将来的なプリセット保存の布石とする。

### フェーズ C: 共通ユーティリティと型の統一（優先度: 中）
- `src/utils` 配下の実使用状況を再棚卸しし、未使用モジュールは記録のうえ保管場所を明示するか削除を検討。
- 頻出ユーティリティを `core/utils` など用途別ディレクトリに再配置し、命名規約とエクスポートスタイルを統一。
- MIDI/シーン間で共有する型定義（レンジ、カラー、ビート情報など）を `src/types` に集約。

### フェーズ D: レンダリング/シェーダ調整（優先度: 低〜中）
- `public/shader/post.frag` の uniform を洗い直し、`TexManager` からの設定値と整合が取れているか検証。
- シェーダ内のマジックナンバーを定数化し、`ColorPalette` との連携を見通し良くする。
- 効果が薄い枝刈りとコメント整備を並行して行い、挙動差分が出ないことを要確認。

### フェーズ E: ドキュメントと検証体制（優先度: 低）
- リファクタ作業の全体像と主要インターフェースを README に追記。
- MIDI ヘルパーなど純粋ロジックに対して軽量なユニットテストを導入できるか調査し、導入時の運用コストを試算。
- ビルドコマンド/手動確認手順をログへ明文化し、将来の変更時に再利用できる形に整える。

---

### 即時アクション（次の作業サイクルで着手）
- フェーズ A の構成案を簡潔に図解または箇条書きでまとめ、`APCMiniMK2Manager` の分割方向を確定させる。
- 分割に伴い必要な新ファイル（例: `GridLedController`, `MidiLedConstants`）のスケルトンを用意し、責務境界を明示。
- 既存ログの記述フォーマットを維持しつつ、新フェーズ進捗を追記できるテンプレートを準備する。

### 段階的シーン設定同期プラン（2025-11-22）
- **目的**: `TexManager` の `setMaxOptionsForScene` と `BandManager.resolveParameters` が同じスキーマに基づいて動くよう共通化する。
- **ステップ 1**: `BandManager` にパラメータスキーマを返す `getParameterSchema()`（仮）を追加し、現行マッピングをそのメソッドへ集約。`resolveParameters` はメソッド経由で値を取得するだけに留め、既存挙動は維持。
- **ステップ 2**: `TexManager.init` で `bandManager.getParameterSchema()` を呼び、取得したスキーマを `sceneMatrix.setMaxOptionsForScene` の引数へ流す。ハードコードを廃止し、動的同期を実現。
- **ステップ 3**: スキーマ構造をミドルレイヤに持ち出す必要が見えてきたら `src/config/sceneRegistry.ts`（仮）を検討。複数シーンをレジストリ経由で登録し、Tex/MIDI/UI が同じソースを参照できる構造へ発展させる。
- **検証**: 各ステップ後に `npm run build` を実施。必要なら MIDI 入力でパラメータ最大値が想定通り反映されるか目視確認し、結果をログへ追記。
